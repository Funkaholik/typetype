// Generated by CoffeeScript 1.7.1
(function() {
  var $;

  $ = jQuery;

  $.fn.extend({
    typetype: function(text, callback, keypress) {
      var charDelay, deferreds, elem, errorProb, interval;
      charDelay = 100;
      errorProb = 0.3;
      interval = function(index) {
        var lastchar, nextchar;
        lastchar = text[index - 1];
        nextchar = text[index];
        return Math.random() * charDelay * (function() {
          switch (lastchar) {
            case nextchar:
              return 1.6;
            case '.':
            case '!':
              return 16;
            case ',':
            case ';':
              return 8;
            case ' ':
              return 3;
            case lastchar === '\n' && nextchar !== '\n':
              return 10;
            default:
              return 2;
          }
        })();
      };
      deferreds = (function() {
        var _i, _len, _results;
        _results = [];
        for (_i = 0, _len = this.length; _i < _len; _i++) {
          elem = this[_i];
          _results.push((function(elem) {
            var continueTo, deferred, makeMistake, recoverMistake, setText, tag;
            tag = elem.tagName.toLowerCase();
            setText = tag === 'input' || tag === 'textarea' ? function(str) {
              return elem.value = str;
            } : function(str) {
              return elem.innerHTML = str;
            };
            makeMistake = function(index) {
              setText(text.substr(0, index) + "X");
              return setTimeout(function() {
                return recoverMistake(index, function() {
                  return continueTo(index + 1);
                });
              }, 2 * interval(index));
            };
            recoverMistake = function(index, cont) {
              setText(text.substr(0, index));
              return setTimeout((function() {
                return cont(index);
              }), interval(index));
            };
            deferred = $.Deferred();
            continueTo = function(index) {
              setText(text.substr(0, index));
              if (keypress != null) {
                keypress.call(elem, index);
              }
              if (index < text.length) {
                if (Math.random() < errorProb) {
                  setTimeout((function() {
                    return makeMistake(index);
                  }), interval(index));
                } else {
                  setTimeout((function() {
                    return continueTo(index + 1);
                  }), interval(index));
                }
              } else {
                deferred.resolve();
              }
            };
            continueTo(1);
            return deferred.done(function() {
              return callback != null ? callback.call(elem) : void 0;
            });
          })(elem));
        }
        return _results;
      }).call(this);
      return $.when.apply($, deferreds);
    }
  });

}).call(this);
